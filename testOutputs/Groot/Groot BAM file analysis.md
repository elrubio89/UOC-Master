# Groot BAM file analysis

Store as a text file to see the structure:

```
samtools view filtered_RTC_149-FR.bam | head -n20> bamfile.txt
```

## Mapped sequences

Nº of mapped sequences: 

```bash
samtools view filtered_RTC_149-FR.bam | wc -l                  
12426 
```

Nº of _unique_ mapped sequences

```bash
samtools view filtered_RTC_149-FR.bam | cut -f1| sort | uniq | wc -l
4891 
```

The same sequence is mapped several times: 

```
samtools view filtered_RTC_149-FR.bam | cut -f1| sort | uniq -c | sort -nr | head -n20

    130 ST-E00129:1006:HCW33CCX2:1:1109:3204:11084 1:N:0:TAAGGCGA+AGAGGATA
    107 ST-E00129:1006:HCW33CCX2:1:1222:16762:36996 2:N:0:TAAGGCGA+AGAGGATA
    106 ST-E00129:1006:HCW33CCX2:1:1109:3265:11224 2:N:0:TAAGGCGA+AGAGGATA
    106 ST-E00129:1006:HCW33CCX2:1:1109:3204:11084 2:N:0:TAAGGCGA+AGAGGATA
     93 ST-E00129:1006:HCW33CCX2:1:2107:8663:19627 2:N:0:TAAGGCGA+AGAGGATA
     84 ST-E00129:1006:HCW33CCX2:1:1123:21734:27538 2:N:0:TAAGGCGA+AGAGGATA
     83 ST-E00129:1006:HCW33CCX2:1:2122:2514:71207 2:N:0:TAAGGCGA+AGAGGATA
     83 ST-E00129:1006:HCW33CCX2:1:1211:24951:23583 1:N:0:TAAGGCGA+AGAGGATA
     77 ST-E00129:1006:HCW33CCX2:1:1124:5264:9308 2:N:0:TAAGGCGA+AGAGGATA
     77 ST-E00129:1006:HCW33CCX2:1:1124:5264:9308 1:N:0:TAAGGCGA+AGAGGATA
     76 ST-E00129:1006:HCW33CCX2:1:2122:2514:71207 1:N:0:TAAGGCGA+AGAGGATA
     59 ST-E00129:1006:HCW33CCX2:1:1203:29203:27363 1:N:0:TAAGGCGA+AGAGGATA
     58 ST-E00129:1006:HCW33CCX2:1:1211:29548:68465 1:N:0:TAAGGCGA+AGAGGATA
     58 ST-E00129:1006:HCW33CCX2:1:1211:29508:69590 1:N:0:TAAGGCGA+AGAGGATA
     55 ST-E00129:1006:HCW33CCX2:1:2111:2788:21403 2:N:0:TAAGGCGA+AGAGGATA
     55 ST-E00129:1006:HCW33CCX2:1:1211:29508:69590 2:N:0:TAAGGCGA+AGAGGATA
     49 ST-E00129:1006:HCW33CCX2:1:1222:16762:36996 1:N:0:TAAGGCGA+AGAGGATA
     45 ST-E00129:1006:HCW33CCX2:1:1211:24951:23583 2:N:0:TAAGGCGA+AGAGGATA
     45 ST-E00129:1006:HCW33CCX2:1:1123:21734:27538 1:N:0:TAAGGCGA+AGAGGATA
     44 ST-E00129:1006:HCW33CCX2:1:2111:2788:21403 1:N:0:TAAGGCGA+AGAGGATA
```

 

Check to which reference sequence are the 2 most repeated sequence mapped 

**1st most repeated sequence**

```bash
samtools view filtered_RTC_149-FR.bam | grep 'ST-E00129:1006:HCW33CCX2:1:1109:3204:11084 1:N:0:TAAGGCGA+AGAGGATA'> subset1.txt
cut -f3 subset1.txt | head               
TEM-101.3000964.AF495873.0-861.842
TEM-106.3000969.AY101578.214-1075.1153
TEM-129.3000993.AJ746225.0-861.1796
TEM-158.3001024.EF534736.213-1074.1569
TEM-78.3000944.AF190693.208-1069.2038
TEM-160.3001026.EF136377.0-861.1798
TEM-6.3000878.X57972.339-1200.1002
TEM-121.3000983.AY271267.0-861.1154
TEM-2.3000874.X54606.214-1075.1724
TEM-209.3001386.KF240808.0-861.1001
```

```bash
cut -f3 subset1.txt | grep TEM | wc -l
130
```

**2nd most repeated sequence:** 

```bash
samtools view filtered_RTC_149-FR.bam | grep 'ST-E00129:1006:HCW33CCX2:1:1222:16762:36996 2:N:0:TAAGGCGA+AGAGGATA'> subset2.txt
cut -f3 subset2.txt | head -n20
TEM-156.3001022.AM941159.208-1069.1400
TEM-45.3000914.X95401.208-1069.1495
TEM-136.3001000.AY826417.0-861.1073
TEM-198.3001057.AB700703.161-1022.1571
TEM-34.3000904.KC292503.4334-5195.1160
TEM-129.3000993.AJ746225.0-861.1796
TEM-139.3001003.DQ072853.0-861.1322
TEM-151.3001018.DQ834729.205-1066.998
TEM-155.3001021.DQ679961.114-975.1323
TEM-166.3001032.FJ197316.0-861.846
TEM-196.3001376.JQ034306.0-861.3690
TEM-3.3000875.X64523.1.476-1337.4678
TEM-128.3000990.AY368237.0-861.1720
TEM-4.3000876.LK391770.1.19707-20568.5503
TEM-71.3000937.AF203816.210-1071.1574
TEM-68.3000935.AJ239002.0-861.1327
TEM-30.3000900.AJ437107.208-1069.930
TEM-214.3001391.KP050491.0-861.2126
TEM-6.3000878.X57972.339-1200.1002
TEM-85.3000952.AJ277414.0-861.1405
```

```bash
cut -f3 subset2.txt | grep TEM | wc -l
107
```

> Sequences are repeatedly mapped to TEM beta-lactamases



### Sequences mapped to TEM beta-lactamase family

Nº of sequences mapped to TEM beta-lactamase family

```bash
samtools view filtered_RTC_149-FR.bam | grep TEM | wc -l 
1644
```

Nº of _unique_ sequences mapped to TEM beta-lactamase family

```bash
samtools view filtered_RTC_149-FR.bam | grep TEM | cut -f1 | sort| uniq| wc -l
31
```



Unique sequences mapped to TEM beta-lactamase family and number of times each sequence is mapped

```bash
samtools view filtered_RTC_149-FR.bam | grep TEM | cut -f1 | sort| uniq -c| sort -nr

    130 ST-E00129:1006:HCW33CCX2:1:1109:3204:11084 1:N:0:TAAGGCGA+AGAGGATA
    107 ST-E00129:1006:HCW33CCX2:1:1222:16762:36996 2:N:0:TAAGGCGA+AGAGGATA
    106 ST-E00129:1006:HCW33CCX2:1:1109:3265:11224 2:N:0:TAAGGCGA+AGAGGATA
    106 ST-E00129:1006:HCW33CCX2:1:1109:3204:11084 2:N:0:TAAGGCGA+AGAGGATA
     93 ST-E00129:1006:HCW33CCX2:1:2107:8663:19627 2:N:0:TAAGGCGA+AGAGGATA
     84 ST-E00129:1006:HCW33CCX2:1:1123:21734:27538 2:N:0:TAAGGCGA+AGAGGATA
     83 ST-E00129:1006:HCW33CCX2:1:2122:2514:71207 2:N:0:TAAGGCGA+AGAGGATA
     83 ST-E00129:1006:HCW33CCX2:1:1211:24951:23583 1:N:0:TAAGGCGA+AGAGGATA
     77 ST-E00129:1006:HCW33CCX2:1:1124:5264:9308 2:N:0:TAAGGCGA+AGAGGATA
     77 ST-E00129:1006:HCW33CCX2:1:1124:5264:9308 1:N:0:TAAGGCGA+AGAGGATA
     76 ST-E00129:1006:HCW33CCX2:1:2122:2514:71207 1:N:0:TAAGGCGA+AGAGGATA
     59 ST-E00129:1006:HCW33CCX2:1:1203:29203:27363 1:N:0:TAAGGCGA+AGAGGATA
     58 ST-E00129:1006:HCW33CCX2:1:1211:29548:68465 1:N:0:TAAGGCGA+AGAGGATA
     58 ST-E00129:1006:HCW33CCX2:1:1211:29508:69590 1:N:0:TAAGGCGA+AGAGGATA
     55 ST-E00129:1006:HCW33CCX2:1:2111:2788:21403 2:N:0:TAAGGCGA+AGAGGATA
     55 ST-E00129:1006:HCW33CCX2:1:1211:29508:69590 2:N:0:TAAGGCGA+AGAGGATA
     49 ST-E00129:1006:HCW33CCX2:1:1222:16762:36996 1:N:0:TAAGGCGA+AGAGGATA
     45 ST-E00129:1006:HCW33CCX2:1:1211:24951:23583 2:N:0:TAAGGCGA+AGAGGATA
     45 ST-E00129:1006:HCW33CCX2:1:1123:21734:27538 1:N:0:TAAGGCGA+AGAGGATA
     44 ST-E00129:1006:HCW33CCX2:1:2111:2788:21403 1:N:0:TAAGGCGA+AGAGGATA
     44 ST-E00129:1006:HCW33CCX2:1:1211:12205:54383 2:N:0:TAAGGCGA+AGAGGATA
     33 ST-E00129:1006:HCW33CCX2:1:1104:18933:43044 2:N:0:TAAGGCGA+AGAGGATA
     26 ST-E00129:1006:HCW33CCX2:1:1115:21521:72561 2:N:0:TAAGGCGA+AGAGGATA
     23 ST-E00129:1006:HCW33CCX2:1:1211:12205:54383 1:N:0:TAAGGCGA+AGAGGATA
     21 ST-E00129:1006:HCW33CCX2:1:2111:17969:45523 1:N:0:TAAGGCGA+AGAGGATA
      2 ST-E00129:1006:HCW33CCX2:1:1224:30036:36047 2:N:0:TAAGGCGA+AGAGGATA
      1 ST-E00129:1006:HCW33CCX2:1:2212:27214:18186 2:N:0:TAAGGCGA+AGAGGATA
      1 ST-E00129:1006:HCW33CCX2:1:2212:27214:18186 1:N:0:TAAGGCGA+AGAGGATA
      1 ST-E00129:1006:HCW33CCX2:1:2115:32502:71014 1:N:0:TAAGGCGA+AGAGGATA
      1 ST-E00129:1006:HCW33CCX2:1:1218:15747:24374 2:N:0:TAAGGCGA+AGAGGATA
      1 ST-E00129:1006:HCW33CCX2:1:1115:21521:72561 1:N:0:TAAGGCGA+AGAGGATA
```

## Reference sequences

Nº sequences mapped to reference sequences (same values as groot-report-0)

```bash
samtools view filtered_RTC_149-FR.bam | cut -f3| sort | uniq -c | sort -nr | head -n20
	1573 CfxA4.3003005.AY769933.0-966.1592
   1409 CfxA3.3003003.AF472622.52-1018.1514
   1387 CfxA2.3003002.AF118110.1.71-1037.4470
   1353 CfxA5.3003096.AY769934.27-993.1669
   1304 *CfxA.3003001.U38243.149-1115.1354
    712 *tetX.3000205.M37699.585-1752.79
    482 *tetQ.3000191.Z21523.0-1974.476
    444 tetW.3000194.AJ222769.3.3686-5606.5145
    308 *tetO.3000190.M18896.2.206-2126.4234
    299 *tet(W/N/W).3004442.KU736867.1.19653-21573.4270
    285 *ErmF.3000498.M17124.1181-1982.593
    191 *CblA-1.3002999.GQ343019.132-1023.1188
    180 *Tet(X3).3004719.MK134375.1.6173-7340.5596
    147 *ErmG.3000522.L42817.201-936.590
    145 *Tet(X4).3004720.MK134376.1.324-1482.5597
    145 *CfxA6.3003097.GQ342996.797-1793.1744
     81 *aadS.3004683.M72415.1.1120-1984.5568
     66 *Mef(En2).3004659.AF251288.1.794-2000.5539
     49 *ErmB.3000375.AF242872.1.2131-2878.5430
     40 *tetM.3000186.AM990992.1.1001760-1003680.5141

```

### Search for cluster containing TEM sequences

Search in folder card.90:

```bash
grep -Ril "TEM"
cluster-560.msa
```

```bash
grep "^>" cluster-560.msa | tail 
>TEM-87.3000954.AF250872.0-861.1575
>TEM-88.3000955.AY027590.112-973.1652
>TEM-90.3000957.AF351241.89-950.1804
>TEM-91.3000958.AB049569.0-861.1888
>TEM-92.3000959.AF143804.0-861.1961
>TEM-93.3000960.AJ318093.0-861.2039
>TEM-94.3000961.AJ318094.0-861.852
>TEM-95.3000962.AJ308558.181-1042.933
>TEM-96.3000963.AY092401.0-861.1004
>consensus
```

```bash
grep "^>" cluster-560.msa | wc -l
149
```

**There are 148 reference sequences clustered in the TEM cluster**

Nº of different TEM reference sequences which are mapped: 

```bash
samtools view filtered_RTC_149-FR.bam | cut -f3| sort | uniq -c | sort -nr | grep TEM | wc -l
147
```

```bash
samtools view filtered_RTC_149-FR.bam | cut -f3| sort | uniq -c | sort -nr | grep TEM | head 
     30 TEM-82.3000949.AF427128.208-1069.1162
     25 TEM-40.3000910.FR717535.0-861.1247
     24 TEM-171.3001037.GQ149347.5269-6130.1244
     24 *TEM-1.3000873.AL513383.161910-162771.1951
     23 TEM-168.3001034.FJ919776.208-1069.999
     22 TEM-219.3003157.KM114268.0-861.1649
     21 TEM-150.3001017.AM183304.208-1069.926
     20 TEM-90.3000957.AF351241.89-950.1804
     20 TEM-73.3000939.AJ012256.208-1069.3324
     20 TEM-54.3000923.AF104442.193-1054.1959
```

> Sequences map repeatedly to all the reference sequences in the cluster. 

### Search for cluster containing CFX sequences

```bash
grep -Ril "cfx"
cluster-183.msa
cluster-182.msa
```

```bash
grep "^>" cluster-182.msa        
>*CfxA.3003001.U38243.149-1115.1354
>CfxA2.3003002.AF118110.1.71-1037.4470
>CfxA3.3003003.AF472622.52-1018.1514
>CfxA4.3003005.AY769933.0-966.1592
>CfxA5.3003096.AY769934.27-993.1669
>consensus

grep "^>" cluster-183.msa
>*CfxA6.3003097.GQ342996.797-1793.1744
>consensus
```

```bash
samtools view filtered_RTC_149-FR.bam | cut -f3| sort | uniq -c | sort -nr | grep -i  CFX | wc -l
6
```

## Flags

```bash
samtools view -f 0 filtered_RTC_149-FR.bam| wc -l                   
12426
```

See how flags are distributed in bam file: 

```bash
samtools view filtered_RTC_149-FR.bam | cut -f2| sort | uniq -c
   2612 0
   2612 16
   3744 256
   3458 272
```

Using samtools view -f

```bash
samtools view -f 0 filtered_RTC_149-FR.bam| wc -l 
12426

samtools view -f 16 filtered_RTC_149-FR.bam| wc -l 
6070

samtools view -f 256 filtered_RTC_149-FR.bam| wc -l 
7202

samtools view -f 272 filtered_RTC_149-FR.bam| wc -l 
3458
```

> Different results are obtained. Why?
>

**Flag meaning**

| Flag | Meaning                                     |
| ---- | ------------------------------------------- |
| 0    | ?                                           |
| 16   | read reverse strand                         |
| 256  | not primary alignment                       |
| 272  | read reverse strand + not primary alignment |

https://broadinstitute.github.io/picard/explain-flags.html

## Quality

```bash
samtools view filtered_RTC_149-FR.bam | cut -f5| sort | uniq -c
12426 30
```

All mapped sequences have 30 as mapping quality value

## CIGAR

```bash
samtools view filtered_RTC_149-FR.bam | cut -f6| sort | uniq | wc -l
82
```

```bash
samtools view filtered_RTC_149-FR.bam | cut -f6| sort | uniq -c | head
20 100M
     40 101M
     15 102M
     32 103M
     12 104M
     40 105M
     35 106M
    160 107M
     27 108M
      7 109M
```

All are matched. Different nº of matched bases is because of different sequence length (after filtering)